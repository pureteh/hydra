<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Architectural Decision Records | Hydra: Head Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://input-output-hk.github.io/head-protocol/adr/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Architectural Decision Records | Hydra: Head Protocol"><meta data-rh="true" name="description" content="Lightweight technical documentation for the Hydra node software."><meta data-rh="true" property="og:description" content="Lightweight technical documentation for the Hydra node software."><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/head-protocol/img/hydra.png"><link data-rh="true" rel="canonical" href="https://input-output-hk.github.io/head-protocol/adr/page/3"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/adr/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/fr/adr/page/3" hreflang="fr"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/ja/adr/page/3" hreflang="ja"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/es/adr/page/3" hreflang="es"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/adr/page/3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YZTAF8IOVB-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/head-protocol/adr/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/adr/atom.xml" title="Hydra: Head Protocol Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Hydra: Head Protocol" href="/head-protocol/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/head-protocol/monthly/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/monthly/atom.xml" title="Hydra: Head Protocol Atom Feed">






<script src="https://plausible.io/js/script.js" defer="defer" data-domain="hydra.family"></script><link rel="stylesheet" href="/head-protocol/assets/css/styles.51fc698e.css">
<link rel="preload" href="/head-protocol/assets/js/runtime~main.5cb89b49.js" as="script">
<link rel="preload" href="/head-protocol/assets/js/main.294c33a4.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/head-protocol/"><div class="navbar__logo"><img src="/head-protocol/img/hydra.png" alt="Hydra: Head Protocol" class="themedImage_ToTc themedImage--light_HNdA"><img src="/head-protocol/img/hydra-white.png" alt="Hydra: Head Protocol" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Hydra: Head Protocol</b></a><a class="navbar__item navbar__link" href="/head-protocol/docs/getting-started">User Manual</a><a class="navbar__item navbar__link" href="/head-protocol/use-cases">Use Cases</a><a class="navbar__item navbar__link" href="/head-protocol/core-concepts">Core Concepts</a><a class="navbar__item navbar__link" href="/head-protocol/topologies">Topologies</a><a class="navbar__item navbar__link" href="/head-protocol/benchmarks">Benchmarks</a><a class="navbar__item navbar__link" href="/head-protocol/api-reference">API Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/input-output-hk/hydra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/head-protocol/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/head-protocol/fr/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Français</a></li><li><a href="/head-protocol/ja/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li><li><a href="/head-protocol/es/adr/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="es">Español</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Architectural Decision Records</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/1">1. Record Architecture Decisions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/2">2. Reactive Core
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/3">3. Asynchronous Duplex Client API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/4">4. Use Handle to model Effects
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/5">5. Use io-classes
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/6">6. Network Broadcasts all messages
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/7">7. Use with-pattern based component interfaces
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/8">8. Custom Prelude
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/9">9. Simplify Logging
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/10">10. Use Direct Connection to `cardano-node`
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/11">11. Use cardano-api
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/12">12. Top-down Test-driven Design
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/13">13. Plutus Contracts Testing Strategy
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/14">14. Token usage in Hydra Scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/15">15. Configuration Through an Admin API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/16">16. Keep Rejected ADRs
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/17">17. Use UDP protocol for Hydra networking
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/18">18. Single state in Hydra.Node.
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/19">19. Use of reference scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/20">20. Handling time
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/21">21. Bounded transaction validity on Hydra protocol transactions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/22">22. Test High-level Properties using Model-Based Testing
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/23">23. Local chain state in chain layer
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/24">24. Persist state changes incrementally
</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/adr/21">21. Bounded transaction validity on Hydra protocol transactions
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-05T00:00:00.000Z" itemprop="datePublished">December 5, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ch1bo" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ch1bo.png" alt="Sebastian Nagel"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ch1bo" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sebastian Nagel</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineering Lead - Hydra @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/pgrange.png" alt="Pascal Grange"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Pascal Grange</span></a></div><small class="avatar__subtitle" itemprop="description">Senior software engineer - Hydra @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ffakenz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ffakenz.png" alt="Franco Testagrossa"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ffakenz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Franco Testagrossa</span></a></div><small class="avatar__subtitle" itemprop="description">Senior software engineer - Hydra @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Architect - Hydra @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/v0d1ch" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/v0d1ch.png" alt="Sasha Bogicevic"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/v0d1ch" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sasha Bogicevic</span></a></div><small class="avatar__subtitle" itemprop="description">Senior software engineer - Hydra @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Proposed</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li><p>The HydraHeadV1 formal specification contains a <em>bounded confirmation window</em>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Deadline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T_max &lt;= T_min + L // Bounded confirmation window</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DL’ = T_max + L    // The latest possible deadline is 2*L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>with <code>T_min</code> and <code>T_max</code> being the tx validity bounds and <code>L</code> being the
contestation period.</p><ul><li>This is to avoid attacks with specified upper validity bound being too far
in the future and denial of service the head with this (e.g. 10 years).</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="current-state-of-things">Current state of things:<a href="#current-state-of-things" class="hash-link" aria-label="Direct link to Current state of things:" title="Direct link to Current state of things:">​</a></h4><ul><li><p>The contestation period and upper tx validity is used for computing the
contestation deadline.</p></li><li><p>There is a <code>closeGraceTime</code> currently hard-coded (to <code>100</code> slots) to set some
upper bound on the <code>closeTx</code>. This was also required so far to compute the
contestation deadline.</p></li><li><p>Different networks (chains) have different slot lenghts, e.g. the preview
network has a slot every <code>1s</code>, while our local devnets use <code>0.1s</code>. This means
hardcoded values like <code>closeGraceTime</code> need to be <em>in sync</em> with the
underlying network.</p></li><li><p>The <code>contestationPeriod</code> can be configured by users via the <code>Init</code> client
input. For example, the hydra-cluster test suite uses a hardcoded <code>cperiod</code> on
the client side.</p></li><li><p>Default value for <code>T_Min</code> is negative infinity.</p></li><li><p>Lower tx validity being in the future does not pose a problem since other
participant is able to close a head.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-we-want-to-achieve">What we want to achieve:<a href="#what-we-want-to-achieve" class="hash-link" aria-label="Direct link to What we want to achieve:" title="Direct link to What we want to achieve:">​</a></h4><ul class="contains-task-list containsTaskList_mC6p"><li><p>We want to enforce topmost formula in this file in our code on-chain.</p></li><li><p>Introduce <code>maxGraceTime</code> expressed in seconds in place of <code>closeGraceTime</code> and adjust to
appropriate value.</p></li><li><p>The contestation period is to be used to create bounded close transaction
(together with <code>maxGraceTime</code>). Before it was only used for computing the
contestation deadline.</p></li><li class="task-list-item"><p><input type="checkbox" checked="" disabled=""> <!-- -->If contestation period is higher than <code>maxGraceTime</code> we will pick the
latter. We still need <code>maxGraceTime</code> since if <code>contestationPeriod</code> is low for
the current network our txs reach the upper bound fast and become invalid.
That is why we set the upper tx bound to be minimum between
<code>contestationPeriod</code> and <code>maxGraceTime</code> so that txs have high enough upper
bound.</p></li><li><p>Make sure all head participants use the same value for <code>contestationPeriod</code>.</p></li><li><p>Attack vector has a corresponding mutation test.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li><p>Use the specification formula on-chain.</p></li><li><p>Configure the contestation period (number of seconds) on the <code>hydra-node</code>,
e.g. via a <code>--contestation-period</code> command line option.</p></li><li><p>Lower tx bound should be the last known slot as reported by the
<code>cardano-node</code>.</p></li><li><p>Upper tx bound is the current time + minimum between <code>contestationPeriod</code> and
<code>maxGraceTime</code>.</p></li><li><p>When submitting the <code>InitTx</code> make sure to use <code>--contestation-period</code> value
from our node&#x27;s flag.</p></li><li><p>If other nodes observe <code>OnInitTx</code> and the <code>contestationPeriod</code> value does not
match with their <code>--contestation-period</code> setting - ignore <code>InitTx</code>.</p></li><li><p>Rename <code>closeGraceTime</code> to <code>maxGraceTime</code> since we are using it also for upper
bound of a contest tx.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li><p>Not any positive number of seconds is a valid contestation period any more!</p></li><li><p>Upper tx validity of close transaction is the minimum between <code>maxGraceTime</code>
and <code>contestationPeriod</code> and this needs to be <em>good enough</em> value with respect
to running network. This is a consequence required by the ledger when
constructing transactions since we cannot convert arbitrary point in times to
slots.</p></li><li><p>All parties need to aggree on contestation period before trying to run a Head
protocol otherwise InitTx will be ignored.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/adr/22">22. Test High-level Properties using Model-Based Testing
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-06T00:00:00.000Z" itemprop="datePublished">December 6, 2022</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li>We have been experimenting with <a href="https://hackage.org/packages/quickcheck-dynamic" target="_blank" rel="noopener noreferrer">quickcheck-dynamic</a> for a while, leading to the implementation of basic <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-node/test/Hydra/ModelSpec.hs" target="_blank" rel="noopener noreferrer">Model-Based tests</a> for the Hydra Head Protocol</li><li>These tests fill a gap in our testing strategy, between <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-node/test/Hydra/BehaviorSpec.hs" target="_blank" rel="noopener noreferrer">BehaviorSpec</a> tests which test a &quot;network&quot; of nodes but only at the level of the off-chain Head logic, and <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-cluster/test/Test/EndToEndSpec.hs" target="_blank" rel="noopener noreferrer">EndToEndSpec</a> tests which test a full blown network of nodes interconnected through real network connections and to a real cardano-node:<ul><li>The former are fast but do not test the complete lifecycle of a Head. Furthermore, they are only unit tests so do not provide coverage into various corner cases that could arise in practice</li><li>The latter exercise the full lifecycle but are very slow and brittle</li></ul></li><li>Because they run in <a href="https://github.com/input-output-hk/io-sim" target="_blank" rel="noopener noreferrer">io-sim</a>, those Model-based tests are fast and robust as they don&#x27;t depend on system interactions. Moreover, decoupling the <em>System-under-Test</em> from <code>IO</code> makes it easy to simulate an environment that deviates from the &quot;happy path&quot; such as delays from the network, filesystem errors, or even adversarial behaviour from the node, or the chain.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li>We will maintain and evolve the <a href="https://github.com/input-output-hk/hydra/blob/master/hydra-node/test/Hydra/Model.hs" target="_blank" rel="noopener noreferrer">Model</a> over time to cover more features</li><li>Key properties of the whole system should be written-down as proper <code>DynamicLogic</code> properties and thoroughly tested using quickcheck-dynamic. This includes but is not limited to:<ul><li>Liveness of the Head</li><li>Consistency of the Head</li><li>Soundness of Chain</li><li>Completeness of Chain</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>We need to ensure the Model covers the full lifecycle of a Hydra Head network which at the time of writing this ADR is not the case</li><li>There cannot be <em>One Model to Rule Them All</em> so we should refrain from defining different <code>StateModel</code> or different <code>RunModel</code> depending on what needs to be tested</li><li>In particular, testing against adversarial conditions will certainly require defining different instances of the <code>Network</code> or <code>Chain</code> components, for example:<ul><li>An <em>Active Adversary</em> that fully the controls the protocol and the parties,</li><li>A <em>Network Adversary</em> that can delay and or drop messages,</li><li>A <em>Faulty Filesystem</em> that can causes exceptions when reading or writing files,</li><li>...</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/adr/23">23. Local chain state in chain layer
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-26T00:00:00.000Z" itemprop="datePublished">April 26, 2023</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li><a href="/head-protocol/adr/18">ADR 18</a> merged both <code>headState</code> and
<code>chainState</code> into one single state in the Hydra node, giving the chain layer a
way to <em>fetch</em> and update the <code>chainState</code> when observing a chain event.</li><li>Having the <code>headState</code> containing the <code>chainState</code> made persistency easier to
deal with: we ensure that we always save cohesive states.</li><li>When opening our first head on mainnet we suffered from a <a href="https://github.com/input-output-hk/hydra/issues/784" target="_blank" rel="noopener noreferrer">commit/rollback
issue</a> that was the
result of a race condition in the management of the <code>chainState</code> as implemented
in the context of <a href="/head-protocol/adr/18">ADR 18</a>.</li><li>Reproducing the issue by introducing rollbacks in the model based tests, we
discovered that, as a client of a hydra-node, we had no idea how to deal with
the rollback event as it is defined now.</li><li><a href="https://github.com/input-output-hk/hydra/issues/185" target="_blank" rel="noopener noreferrer">#185</a> plans to improve
rollback management.</li></ul><p>The following picture details the race condition through an exemple:</p><ol><li><p>The DirectChain component fetch some <code>chainState 0</code> from the <code>headState</code></p></li><li><p>The DirectChain component observes a transaction and it</p></li></ol><ul><li>publishes an event about this observation</li><li>updates the <code>headState</code> with some <code>chainState 1</code></li></ul><ol><li>The Node processes the event and emits a new <code>headState</code> with a
<code>previousRecoverableState</code> in case a rollback later happens</li></ol><p>The problem is that <code>HeadState 2</code> in the figure should point to a previous
recoverable head state containing <code>chainState 0</code> and not <code>chainState 1</code>.</p><p><img loading="lazy" alt="race condition" src="/head-protocol/assets/images/2023-04-26-023-race-condition-7bc6b62f01470cdeaaaf81ec5227363e.jpg" width="2310" height="1731" class="img_ev3q"></p><p>Updating the chain state only in the <code>HeadLogic</code> leads to problems when several
transactions are in the same block. This can be mitigated by keeping a volatile
chain state locally while analysing the block. But then it leads to race
conditions issues if, for some reason, blocks are produced faster than they are
processed by the HeadLogic. Low probability in production but higher when
testing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><ul><li>We supersede <a href="/head-protocol/adr/18">ADR 18</a> with the current ADR.</li><li>A local chain state is re-introduced in the chain component, not shared with
the head logic.</li><li>A copy of the <code>chainState</code> is kept in the <code>headState</code> to keep the benefits of
<a href="/head-protocol/adr/18">ADR 18</a> regarding persistency.</li><li>The <code>RolledBack</code> output is removed from the API unless actionable by users or
<a href="https://github.com/input-output-hk/hydra/issues/185" target="_blank" rel="noopener noreferrer">#185</a> implemented.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>The rollback logic is removed from the HeadLogic and only maintained in the
chain component.</li><li>The Rollback event carries the ChainState.</li><li>At the node startup, we initialize the chain layer with the persisted
<code>chainState</code></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/adr/tags/accepted">Accepted</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/head-protocol/adr/24">24. Persist state changes incrementally
</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-19T00:00:00.000Z" itemprop="datePublished">June 19, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Architect - Hydra @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Proposed</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><ul><li>The state of a Hydra Head is currently persisted as a whole upon each <code>NewState</code> <em>outcome</em> from the <code>update</code> function: The new state is serialised and the <code>state</code> file is overwritten with the corresponding bytes. While this is a straightforward strategy to implement, it has a huge impact on the performance of a Hydra Head as serialising a large data structure like the <code>HeadState</code> and completely overwriting a file is costly<ul><li>We revisited our benchmarks and <a href="https://github.com/input-output-hk/hydra/issues/186#issuecomment-1584292265" target="_blank" rel="noopener noreferrer">found</a> that persistence was the major bottleneck when measuring roundtrip confirmation time,e g. the time it takes from a client&#x27;s perspective to submit a transaction and observe in a <code>ConfirmedSnapshot</code></li></ul></li><li>Furthermore, the way we currently handle changes to the <code>HeadState</code> in the hydra-node, while conceptually being an <code>Effect</code> is handled differently from other <code>Effect</code>s: The state is updated transactionally through a dedicated <code>modifyHeadState</code> function in the core loop of processing events, and <em>then</em> effects are processed.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><p>Implement state persistence using <a href="https://thinkbeforecoding.com/post/2013/07/28/Event-Sourcing-vs-Command-Sourcing" target="_blank" rel="noopener noreferrer"><em>Event Sourcing</em></a>. Practically, this means:</p><ol><li>Replace the <code>NewState</code> outcome with a <code>StateChanged</code> <em>event</em> which can be part of the <code>Outcome</code> of <code>HeadLogic</code>&#x27;s <code>update</code> function, representing the <em>change</em> to be applied to the current state.</li><li>Add a dedicated <a href="/head-protocol/adr/4">handle</a> to manage <code>StateChanged</code> events, applying them, and maintaining current <code>HeadState</code></li><li>Persist <code>StateChanged</code>s in an append-only log</li><li>Upon node startup, reread <code>StateChanged</code> events log and reapply those to reset the <code>HeadState</code></li><li><em>(Optional)</em>: Make <code>StateChanged</code> <em>invertible</em></li></ol><p>The following sequence diagram illustrates new event handling in the <code>HeadLogic</code>:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>🐎 The main expected consequence of this change is an increase of the overall performance of Hydra Head network</li><li>While <em>Effect handlers</em> might be asynchronous, <code>StateChanged</code> handler <em>must</em> be synchronous to ensure consistency and durability of state changes</li><li>An longer term consequence is the possibilities this change introduces with respect to <code>ServerOutput</code> handling and client&#x27;s access to a head&#x27;s state:<ul><li>Instead of having the <code>HeadLogic</code> emits directly a <code>ClientEffect</code>, the latter could be the result of a client-centric <em>interpretation</em> of a <code>StateChanged</code></li><li>Pushing this a little further, we could maintain a <em>Query Model</em> for clients with a dedicated <a href="https://github.com/input-output-hk/hydra/discussions/686" target="_blank" rel="noopener noreferrer">Query API</a> to ease implementation of stateless clients</li></ul></li><li>Crashing nodes could catch-up with the Head&#x27;s state by requesting <code>StateChanged</code> changes they are missing</li><li>Calling <code>StateChanged</code> an <em>event</em> while treating it in the code alongside <em>effects</em> might introduce some confusion as we already use the word <a href="https://github.com/input-output-hk/hydra/blob/45913954eb18ef550a31017daa443cee6720a00c/hydra-node/src/Hydra/HeadLogic.hs#L64" target="_blank" rel="noopener noreferrer">Event</a> to designate the inputs to the Head logic state machine. We might want at some later point to unify the terminology</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/adr/tags/proposed">Proposed</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/head-protocol/adr/page/2"><div class="pagination-nav__label">Newer Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Coding-Standards" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding Standards</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/adr">Architectural Decision Records</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Testing-Strategy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Testing Strategy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/Qq5vNTg9PT" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord (#ask-hydra)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://cardano.stackexchange.com/questions/tagged/hydra" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Exchange<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/head-protocol/docs/haskell_packages">Haskell Packages</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/monthly">Monthly reports</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Logbook" target="_blank" rel="noopener noreferrer" class="footer__link-item">Logbook</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://static.iohk.io/terms/iohktermsandconditions.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms &amp; Conditions</a></li><li class="footer__item"><a href="https://static.iohk.io/terms/iog-privacy-policy.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/graphs/contributors" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contributors</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
          <small>
          Built with Docusaurus on 2023-06-30T11:17:32+02:00
          </small>
          </div></div></div></footer></div>
<script src="/head-protocol/assets/js/runtime~main.5cb89b49.js"></script>
<script src="/head-protocol/assets/js/main.294c33a4.js"></script>
</body>
</html>