<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hydra.API.Server</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Hydra.Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier">seq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">newEmptyMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">putMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">takeMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TChan</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">dupTChan</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTChan</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TChan</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">newBroadcastTChanIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTChan</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">TVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modifyTVar'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">newTVarIO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">readTVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">IOException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Aeson</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LBS</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Data.Version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">showVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.ClientInput.html"><span class="hs-identifier">Hydra.API.ClientInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier">ClientInput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.Projection.html"><span class="hs-identifier">Hydra.API.Projection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier">Projection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier">mkProjection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.RestServer.html"><span class="hs-identifier">Hydra.API.RestServer</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Hydra.API.RestServer.html#DraftCommitTxRequest"><span class="hs-identifier">DraftCommitTxRequest</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><a href="Hydra.API.RestServer.html#DraftCommitTxResponse"><span class="hs-identifier">DraftCommitTxResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><a href="Hydra.API.RestServer.html#fromTxOutWithWitness"><span class="hs-identifier">fromTxOutWithWitness</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html"><span class="hs-identifier">Hydra.API.ServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#HeadStatus"><span class="hs-identifier">HeadStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#Idle"><span class="hs-identifier">Idle</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#OutputFormat"><span class="hs-identifier">OutputFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier">ServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#Greetings"><span class="hs-identifier">Greetings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#InvalidInput"><span class="hs-identifier">InvalidInput</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#hydraNodeVersion"><span class="hs-identifier">hydraNodeVersion</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutputConfig"><span class="hs-identifier">ServerOutputConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier">TimedServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#WithUTxO"><span class="hs-identifier">WithUTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#headStatus"><span class="hs-identifier">headStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#me"><span class="hs-identifier">me</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#prepareServerOutput"><span class="hs-identifier">prepareServerOutput</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectHeadStatus"><span class="hs-identifier">projectHeadStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectSnapshotUtxo"><span class="hs-identifier">projectSnapshotUtxo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#snapshotUtxo"><span class="hs-identifier">snapshotUtxo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Chain.html"><span class="hs-identifier">Hydra.Chain</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier">Chain</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier">IsChainState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#PostTxError"><span class="hs-identifier">PostTxError</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Hydra.Chain.html#CannotCommitReferenceScript"><span class="hs-identifier">CannotCommitReferenceScript</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Hydra.Chain.html#CommittedTooMuchADAForMainnet"><span class="hs-identifier">CommittedTooMuchADAForMainnet</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Hydra.Chain.html#SpendingNodeUtxoForbidden"><span class="hs-identifier">SpendingNodeUtxoForbidden</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Hydra.Chain.html#UnsupportedLegacyOutput"><span class="hs-identifier">UnsupportedLegacyOutput</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Chain.Direct.State.html"><span class="hs-identifier">Hydra.Chain.Direct.State</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Ledger.html"><span class="hs-identifier">Hydra.Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Ledger.html#UTxOType"><span class="hs-identifier">UTxOType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Logging.html"><span class="hs-identifier">Hydra.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Network.html"><span class="hs-identifier">Hydra.Network</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IP</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PortNumber</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Hydra.Options.html"><span class="hs-identifier">Hydra.Options</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Options</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Party.html"><span class="hs-identifier">Hydra.Party</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier">Party</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Persistence.html"><span class="hs-identifier">Hydra.Persistence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier">PersistenceIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Method</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">status200</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">status400</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">status500</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="hs-identifier">Request</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pathInfo</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><span class="hs-identifier">Response</span></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="hs-identifier">ResponseReceived</span></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><span class="hs-identifier">consumeRequestBodyStrict</span></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="hs-identifier">requestMethod</span></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="hs-identifier">responseLBS</span></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.Warp</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><span class="hs-identifier">defaultSettings</span></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="hs-identifier">runSettings</span></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="hs-identifier">setBeforeMainLoop</span></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><span class="hs-identifier">setHost</span></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><span class="hs-identifier">setOnException</span></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><span class="hs-identifier">setPort</span></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.WebSockets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">websocketsOr</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.WebSockets</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><span class="hs-identifier">PendingConnection</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pendingRequest</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><span class="hs-identifier">RequestHead</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="hs-identifier">acceptRequest</span></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><span class="hs-identifier">defaultConnectionOptions</span></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="hs-identifier">receiveData</span></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><span class="hs-identifier">sendTextData</span></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><span class="hs-identifier">sendTextDatas</span></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><span class="hs-identifier">withPingThread</span></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Test.QuickCheck</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">oneof</span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.URI</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ParseException</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.URI.QQ</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">queryKey</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">queryValue</span></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span id="local-6989586621680107939"><span id="local-6989586621680107940"></span></span><span class="hs-keyword">data</span><span> </span><span id="APIServerLog"><span class="annot"><a href="Hydra.API.Server.html#APIServerLog"><span class="hs-identifier hs-var">APIServerLog</span></a></span></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="APIServerStarted"><span class="annot"><a href="Hydra.API.Server.html#APIServerStarted"><span class="hs-identifier hs-var">APIServerStarted</span></a></span></span><span> </span><span class="hs-special">{</span><span id="listeningPort"><span class="annot"><span class="annottext">APIServerLog -&gt; PortNumber
</span><a href="Hydra.API.Server.html#listeningPort"><span class="hs-identifier hs-var hs-var">listeningPort</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span class="hs-special">}</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NewAPIConnection"><span class="annot"><a href="Hydra.API.Server.html#NewAPIConnection"><span class="hs-identifier hs-var">NewAPIConnection</span></a></span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="APIOutputSent"><span class="annot"><a href="Hydra.API.Server.html#APIOutputSent"><span class="hs-identifier hs-var">APIOutputSent</span></a></span></span><span> </span><span class="hs-special">{</span><span id="sentOutput"><span class="annot"><span class="annottext">APIServerLog -&gt; Value
</span><a href="Hydra.API.Server.html#sentOutput"><span class="hs-identifier hs-var hs-var">sentOutput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Aeson.Value</span></span><span class="hs-special">}</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="APIInputReceived"><span class="annot"><a href="Hydra.API.Server.html#APIInputReceived"><span class="hs-identifier hs-var">APIInputReceived</span></a></span></span><span> </span><span class="hs-special">{</span><span id="receivedInput"><span class="annot"><span class="annottext">APIServerLog -&gt; Value
</span><a href="Hydra.API.Server.html#receivedInput"><span class="hs-identifier hs-var hs-var">receivedInput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Aeson.Value</span></span><span class="hs-special">}</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="APIInvalidInput"><span class="annot"><a href="Hydra.API.Server.html#APIInvalidInput"><span class="hs-identifier hs-var">APIInvalidInput</span></a></span></span><span> </span><span class="hs-special">{</span><span id="reason"><span class="annot"><span class="annottext">APIServerLog -&gt; String
</span><a href="Hydra.API.Server.html#reason"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">,</span><span> </span><span id="inputReceived"><span class="annot"><span class="annottext">APIServerLog -&gt; Text
</span><a href="Hydra.API.Server.html#inputReceived"><span class="hs-identifier hs-var hs-var">inputReceived</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="APIConnectionError"><span class="annot"><a href="Hydra.API.Server.html#APIConnectionError"><span class="hs-identifier hs-var">APIConnectionError</span></a></span></span><span> </span><span class="hs-special">{</span><span id="reason"><span class="annot"><a href="Hydra.API.Server.html#reason"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="APIHandshakeError"><span class="annot"><a href="Hydra.API.Server.html#APIHandshakeError"><span class="hs-identifier hs-var">APIHandshakeError</span></a></span></span><span> </span><span class="hs-special">{</span><span id="reason"><span class="annot"><a href="Hydra.API.Server.html#reason"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="APIRestInputReceived"><span class="annot"><a href="Hydra.API.Server.html#APIRestInputReceived"><span class="hs-identifier hs-var">APIRestInputReceived</span></a></span></span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="method"><span class="annot"><span class="annottext">APIServerLog -&gt; Text
</span><a href="Hydra.API.Server.html#method"><span class="hs-identifier hs-var hs-var">method</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="paths"><span class="annot"><span class="annottext">APIServerLog -&gt; [Text]
</span><a href="Hydra.API.Server.html#paths"><span class="hs-identifier hs-var hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="requestInputBody"><span class="annot"><span class="annottext">APIServerLog -&gt; Maybe Value
</span><a href="Hydra.API.Server.html#requestInputBody"><span class="hs-identifier hs-var hs-var">requestInputBody</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Aeson.Value</span></span><span>
</span><span id="line-101"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680107903"><span id="local-6989586621680107921"><span class="annot"><span class="annottext">APIServerLog -&gt; APIServerLog -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: APIServerLog -&gt; APIServerLog -&gt; Bool
$c/= :: APIServerLog -&gt; APIServerLog -&gt; Bool
== :: APIServerLog -&gt; APIServerLog -&gt; Bool
$c== :: APIServerLog -&gt; APIServerLog -&gt; Bool
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680107871"><span id="local-6989586621680107873"><span id="local-6989586621680107899"><span class="annot"><span class="annottext">Int -&gt; APIServerLog -&gt; ShowS
[APIServerLog] -&gt; ShowS
APIServerLog -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [APIServerLog] -&gt; ShowS
$cshowList :: [APIServerLog] -&gt; ShowS
show :: APIServerLog -&gt; String
$cshow :: APIServerLog -&gt; String
showsPrec :: Int -&gt; APIServerLog -&gt; ShowS
$cshowsPrec :: Int -&gt; APIServerLog -&gt; ShowS
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall x. Rep APIServerLog x -&gt; APIServerLog
forall x. APIServerLog -&gt; Rep APIServerLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep APIServerLog x -&gt; APIServerLog
$cfrom :: forall x. APIServerLog -&gt; Rep APIServerLog x
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680107858"><span id="local-6989586621680107860"><span id="local-6989586621680107862"><span id="local-6989586621680107864"><span class="annot"><span class="annottext">[APIServerLog] -&gt; Value
[APIServerLog] -&gt; Encoding
APIServerLog -&gt; Value
APIServerLog -&gt; Encoding
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [APIServerLog] -&gt; Encoding
$ctoEncodingList :: [APIServerLog] -&gt; Encoding
toJSONList :: [APIServerLog] -&gt; Value
$ctoJSONList :: [APIServerLog] -&gt; Value
toEncoding :: APIServerLog -&gt; Encoding
$ctoEncoding :: APIServerLog -&gt; Encoding
toJSON :: APIServerLog -&gt; Value
$ctoJSON :: APIServerLog -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680107853"><span id="local-6989586621680107855"><span class="annot"><span class="annottext">Value -&gt; Parser [APIServerLog]
Value -&gt; Parser APIServerLog
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [APIServerLog]
$cparseJSONList :: Value -&gt; Parser [APIServerLog]
parseJSON :: Value -&gt; Parser APIServerLog
$cparseJSON :: Value -&gt; Parser APIServerLog
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680107849"><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#APIServerLog"><span class="hs-identifier hs-type">APIServerLog</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-106"></span><span>  </span><span id="local-6989586621680107816"><span class="annot"><span class="annottext">arbitrary :: Gen APIServerLog
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">arbitrary</span></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">forall a. [Gen a] -&gt; Gen a
</span><span class="hs-identifier hs-var">oneof</span></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">PortNumber -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIServerStarted"><span class="hs-identifier hs-var">APIServerStarted</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">APIServerLog
</span><a href="Hydra.API.Server.html#NewAPIConnection"><span class="hs-identifier hs-var">NewAPIConnection</span></a></span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIOutputSent"><span class="hs-identifier hs-var">APIOutputSent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Aeson.Object</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIInputReceived"><span class="hs-identifier hs-var">APIInputReceived</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Aeson.Object</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIInvalidInput"><span class="hs-identifier hs-var">APIInvalidInput</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIConnectionError"><span class="hs-identifier hs-var">APIConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIHandshakeError"><span class="hs-identifier hs-var">APIHandshakeError</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Maybe Value -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIRestInputReceived"><span class="hs-identifier hs-var">APIRestInputReceived</span></a></span><span>
</span><span id="line-116"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span>
</span><span id="line-117"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span>
</span><span id="line-118"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [Gen a] -&gt; Gen a
</span><span class="hs-identifier hs-var">oneof</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Aeson.Object</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | Handle to provide a means for sending server outputs to clients.</span><span>
</span><span id="line-122"></span><span class="hs-keyword">newtype</span><span> </span><span id="Server"><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span> </span><span id="local-6989586621680108883"><span class="annot"><a href="#local-6989586621680108883"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680108882"><span class="annot"><a href="#local-6989586621680108882"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Server"><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="sendOutput"><span class="annot"><span class="annottext">forall tx (m :: * -&gt; *). Server tx m -&gt; ServerOutput tx -&gt; m ()
</span><a href="Hydra.API.Server.html#sendOutput"><span class="hs-identifier hs-var hs-var">sendOutput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier hs-type">ServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108883"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680108882"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-comment">-- ^ Send some output to all connected clients.</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | Callback for receiving client inputs.</span><span>
</span><span id="line-128"></span><span class="hs-keyword">type</span><span> </span><span id="ServerCallback"><span class="annot"><a href="Hydra.API.Server.html#ServerCallback"><span class="hs-identifier hs-var">ServerCallback</span></a></span></span><span> </span><span id="local-6989586621680107810"><span class="annot"><a href="#local-6989586621680107810"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680107809"><span class="annot"><a href="#local-6989586621680107809"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier hs-type">ClientInput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107810"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680107809"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- | A type tying both receiving input and sending output into a /Component/.</span><span>
</span><span id="line-131"></span><span class="hs-keyword">type</span><span> </span><span id="ServerComponent"><span class="annot"><a href="Hydra.API.Server.html#ServerComponent"><span class="hs-identifier hs-var">ServerComponent</span></a></span></span><span> </span><span id="local-6989586621680107808"><span class="annot"><a href="#local-6989586621680107808"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680107807"><span class="annot"><a href="#local-6989586621680107807"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680107806"><span class="annot"><a href="#local-6989586621680107806"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.Server.html#ServerCallback"><span class="hs-identifier hs-type">ServerCallback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107808"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107807"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107808"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107807"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680107807"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107806"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680107807"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680107806"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="Hydra.API.Server.html#withAPIServer"><span class="hs-identifier hs-type">withAPIServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680108877"><span class="annot"><a href="#local-6989586621680108877"><span class="hs-identifier hs-type">tx</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier hs-type">IsChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108877"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier hs-type">Party</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier hs-type">PersistenceIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108877"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#APIServerLog"><span class="hs-identifier hs-type">APIServerLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108877"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><a href="Hydra.API.Server.html#ServerComponent"><span class="hs-identifier hs-type">ServerComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108877"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span id="withAPIServer"><span class="annot"><span class="annottext">withAPIServer :: forall tx.
IsChainState tx =&gt;
IP
-&gt; PortNumber
-&gt; Party
-&gt; PersistenceIncremental (TimedServerOutput tx) IO
-&gt; Tracer IO APIServerLog
-&gt; Chain tx IO
-&gt; ServerComponent tx IO ()
</span><a href="Hydra.API.Server.html#withAPIServer"><span class="hs-identifier hs-var hs-var">withAPIServer</span></a></span></span><span> </span><span id="local-6989586621680107763"><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680107763"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span id="local-6989586621680107762"><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680107762"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621680107761"><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680107761"><span class="hs-identifier hs-var">party</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier hs-type">PersistenceIncremental</span></a></span><span class="hs-special">{</span><span id="local-6989586621680107759"><span class="annot"><span class="annottext">FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
loadAll :: forall a (m :: * -&gt; *).
PersistenceIncremental a m -&gt; FromJSON a =&gt; m [a]
loadAll :: FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
</span><a href="Hydra.Persistence.html#loadAll"><span class="hs-identifier hs-var hs-var">loadAll</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680107757"><span class="annot"><span class="annottext">ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
append :: forall a (m :: * -&gt; *).
PersistenceIncremental a m -&gt; ToJSON a =&gt; a -&gt; m ()
append :: ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
</span><a href="Hydra.Persistence.html#append"><span class="hs-identifier hs-var hs-var">append</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680107755"><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107755"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680107754"><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107754"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span id="local-6989586621680107753"><span class="annot"><span class="annottext">ServerCallback tx IO
</span><a href="#local-6989586621680107753"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621680107752"><span class="annot"><span class="annottext">Server tx IO -&gt; IO ()
</span><a href="#local-6989586621680107752"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621680107751"><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107751"><span class="hs-identifier hs-var">responseChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. IO (TChan a)
</span><span class="hs-identifier hs-var">newBroadcastTChanIO</span></span><span>
</span><span id="line-145"></span><span>  </span><span id="local-6989586621680107750"><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680107750"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
</span><a href="#local-6989586621680107759"><span class="hs-identifier hs-var">loadAll</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-comment">-- Intialize our read model from stored events</span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621680107749"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680107749"><span class="hs-identifier hs-var">headStatusP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">HeadStatus
</span><a href="Hydra.API.ServerOutput.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#output"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680107750"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall tx. HeadStatus -&gt; ServerOutput tx -&gt; HeadStatus
</span><a href="Hydra.API.ServerOutput.html#projectHeadStatus"><span class="hs-identifier hs-var">projectHeadStatus</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621680107747"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107747"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#output"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680107750"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall tx.
Maybe (UTxOType tx) -&gt; ServerOutput tx -&gt; Maybe (UTxOType tx)
</span><a href="Hydra.API.ServerOutput.html#projectSnapshotUtxo"><span class="hs-identifier hs-var">projectSnapshotUtxo</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-comment">-- NOTE: we need to reverse the list because we store history in a reversed</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-comment">-- list in memory but in order on disk</span><span>
</span><span id="line-153"></span><span>  </span><span id="local-6989586621680107746"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107746"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; IO (TVar a)
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680107750"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680107744"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680107744"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680107743"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680107743"><span class="hs-identifier hs-var">waitForServerRunning</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IO (), IO ())
</span><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-var">setupServerNotification</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tx.
IsChainState tx =&gt;
IP
-&gt; PortNumber
-&gt; Party
-&gt; Tracer IO APIServerLog
-&gt; TVar [TimedServerOutput tx]
-&gt; Chain tx IO
-&gt; (ClientInput tx -&gt; IO ())
-&gt; Projection STM (ServerOutput tx) HeadStatus
-&gt; Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
-&gt; TChan (TimedServerOutput tx)
-&gt; IO ()
-&gt; IO ()
</span><a href="Hydra.API.Server.html#runAPIServer"><span class="hs-identifier hs-var">runAPIServer</span></a></span><span> </span><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680107763"><span class="hs-identifier hs-var">host</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680107762"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680107761"><span class="hs-identifier hs-var">party</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107755"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107746"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107754"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">ServerCallback tx IO
</span><a href="#local-6989586621680107753"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680107749"><span class="hs-identifier hs-var">headStatusP</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107747"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107751"><span class="hs-identifier hs-var">responseChannel</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680107744"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680107743"><span class="hs-identifier hs-var">waitForServerRunning</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><span class="annottext">Server tx IO -&gt; IO ()
</span><a href="#local-6989586621680107752"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>
</span><span id="line-161"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sendOutput :: ServerOutput tx -&gt; IO ()
</span><a href="Hydra.API.Server.html#sendOutput"><span class="hs-identifier hs-var">sendOutput</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680107739"><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680107739"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>                </span><span id="local-6989586621680107738"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107738"><span class="hs-identifier hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
-&gt; ServerOutput tx -&gt; IO (TimedServerOutput tx)
</span><a href="#local-6989586621680107737"><span class="hs-identifier hs-var">appendToHistory</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107746"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680107739"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-163"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>                  </span><span class="annot"><span class="annottext">forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#update"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680107749"><span class="hs-identifier hs-var">headStatusP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680107739"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-165"></span><span>                  </span><span class="annot"><span class="annottext">forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#update"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107747"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680107739"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-166"></span><span>                  </span><span class="annot"><span class="annottext">forall a. TChan a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107751"><span class="hs-identifier hs-var">responseChannel</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107738"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-167"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621680107737"><span class="annot"><span class="annottext">appendToHistory :: TVar [TimedServerOutput tx]
-&gt; ServerOutput tx -&gt; IO (TimedServerOutput tx)
</span><a href="#local-6989586621680107737"><span class="hs-identifier hs-var hs-var">appendToHistory</span></a></span></span><span> </span><span id="local-6989586621680107734"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107734"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span id="local-6989586621680107733"><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680107733"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621680107732"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680107732"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadTime m =&gt; m UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621680107730"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107730"><span class="hs-identifier hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>      </span><span id="local-6989586621680107729"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680107729"><span class="hs-identifier hs-var">seq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tx. TVar [TimedServerOutput tx] -&gt; STM Natural
</span><a href="Hydra.API.Server.html#nextSequenceNumber"><span class="hs-identifier hs-var">nextSequenceNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107734"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107727"><span class="annot"><span class="annottext">timedOutput :: TimedServerOutput tx
</span><a href="#local-6989586621680107727"><span class="hs-identifier hs-var hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ServerOutput tx
output :: ServerOutput tx
output :: ServerOutput tx
</span><a href="#local-6989586621680107733"><span class="hs-identifier hs-var hs-var">output</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTCTime
time :: UTCTime
time :: UTCTime
</span><a href="Hydra.API.ServerOutput.html#time"><span class="hs-identifier hs-var hs-var">time</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
seq :: Natural
seq :: Natural
</span><a href="Hydra.API.ServerOutput.html#seq"><span class="hs-identifier hs-var hs-var">seq</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-175"></span><span>      </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107734"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107727"><span class="hs-identifier hs-var">timedOutput</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107727"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
</span><a href="#local-6989586621680107757"><span class="hs-identifier hs-var">append</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107730"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107730"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span id="local-6989586621680108827"><span class="annot"><a href="Hydra.API.Server.html#nextSequenceNumber"><span class="hs-identifier hs-type">nextSequenceNumber</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108827"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM.STM</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-bignum-1.3/src"><span class="hs-identifier hs-type">Natural</span></a></span></span><span>
</span><span id="line-181"></span><span id="nextSequenceNumber"><span class="annot"><span class="annottext">nextSequenceNumber :: forall tx. TVar [TimedServerOutput tx] -&gt; STM Natural
</span><a href="Hydra.API.Server.html#nextSequenceNumber"><span class="hs-identifier hs-var hs-var">nextSequenceNumber</span></a></span></span><span> </span><span id="local-6989586621680107716"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107716"><span class="hs-identifier hs-var">historyList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="annottext">forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107716"><span class="hs-identifier hs-var">historyList</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span class="hs-special">{</span><span id="local-6989586621680107715"><span class="annot"><span class="annottext">Natural
seq :: Natural
seq :: forall tx. TimedServerOutput tx -&gt; Natural
</span><a href="#local-6989586621680107715"><span class="hs-identifier hs-var hs-var">seq</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680107715"><span class="hs-identifier hs-var">seq</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-keyword">type</span><span> </span><span id="NotifyServerRunning"><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-var">NotifyServerRunning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-keyword">type</span><span> </span><span id="WaitForServer"><span class="annot"><a href="Hydra.API.Server.html#WaitForServer"><span class="hs-identifier hs-var">WaitForServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | Setup notification and waiter to ensure that something only runs after the</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- server is actually listening.</span><span>
</span><span id="line-192"></span><span class="annot"><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-type">setupServerNotification</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-type">NotifyServerRunning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.Server.html#WaitForServer"><span class="hs-identifier hs-type">WaitForServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span id="setupServerNotification"><span class="annot"><span class="annottext">setupServerNotification :: IO (IO (), IO ())
</span><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-var hs-var">setupServerNotification</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>  </span><span id="local-6989586621680107711"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680107711"><span class="hs-identifier hs-var">mv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. IO (MVar a)
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">newEmptyMVar</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680107711"><span class="hs-identifier hs-var">mv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; IO a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680107711"><span class="hs-identifier hs-var">mv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="annot"><a href="Hydra.API.Server.html#runAPIServer"><span class="hs-identifier hs-type">runAPIServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680108837"><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier hs-type">IsChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier hs-type">Party</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#APIServerLog"><span class="hs-identifier hs-type">APIServerLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier hs-type">ClientInput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-comment">-- | Read model to enhance 'Greetings' messages with 'HeadStatus'.</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier hs-type">Projection</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier hs-type">ServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#HeadStatus"><span class="hs-identifier hs-type">HeadStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-comment">-- | Read model to enhance 'Greetings' messages with snapshot UTxO.</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier hs-type">Projection</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">STM.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier hs-type">ServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Ledger.html#UTxOType"><span class="hs-identifier hs-type">UTxOType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-comment">-- | Called when the server is listening before entering the main loop.</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-type">NotifyServerRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span id="runAPIServer"><span class="annot"><span class="annottext">runAPIServer :: forall tx.
IsChainState tx =&gt;
IP
-&gt; PortNumber
-&gt; Party
-&gt; Tracer IO APIServerLog
-&gt; TVar [TimedServerOutput tx]
-&gt; Chain tx IO
-&gt; (ClientInput tx -&gt; IO ())
-&gt; Projection STM (ServerOutput tx) HeadStatus
-&gt; Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
-&gt; TChan (TimedServerOutput tx)
-&gt; IO ()
-&gt; IO ()
</span><a href="Hydra.API.Server.html#runAPIServer"><span class="hs-identifier hs-var hs-var">runAPIServer</span></a></span></span><span> </span><span id="local-6989586621680107608"><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680107608"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span id="local-6989586621680107607"><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680107607"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621680107606"><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680107606"><span class="hs-identifier hs-var">party</span></a></span></span><span> </span><span id="local-6989586621680107605"><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680107604"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107604"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span id="local-6989586621680107603"><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107603"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span id="local-6989586621680107602"><span class="annot"><span class="annottext">ClientInput tx -&gt; IO ()
</span><a href="#local-6989586621680107602"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621680107601"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680107601"><span class="hs-identifier hs-var">headStatusP</span></a></span></span><span> </span><span id="local-6989586621680107600"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107600"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span></span><span> </span><span id="local-6989586621680107599"><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107599"><span class="hs-identifier hs-var">responseChannel</span></a></span></span><span> </span><span id="local-6989586621680107598"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680107598"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PortNumber -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIServerStarted"><span class="hs-identifier hs-var">APIServerStarted</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680107607"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-comment">-- catch and rethrow with more context</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="annot"><span class="annottext">IOException -&gt; IO ()
</span><a href="#local-6989586621680107596"><span class="hs-identifier hs-var">onIOException</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">Settings -&gt; Application -&gt; IO ()
</span><span class="hs-identifier hs-var">runSettings</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621680107595"><span class="hs-identifier hs-var">serverSettings</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">ConnectionOptions -&gt; ServerApp -&gt; Application -&gt; Application
</span><span class="hs-identifier hs-var">websocketsOr</span></span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><span class="hs-identifier hs-var">defaultConnectionOptions</span></span><span> </span><span class="annot"><span class="annottext">ServerApp
</span><a href="#local-6989586621680107594"><span class="hs-identifier hs-var">wsApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Chain tx IO -&gt; Application
</span><a href="#local-6989586621680107593"><span class="hs-identifier hs-var">httpApp</span></a></span><span> </span><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107603"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-222"></span><span>  </span><span id="local-6989586621680107595"><span class="annot"><span class="annottext">serverSettings :: Settings
</span><a href="#local-6989586621680107595"><span class="hs-identifier hs-var hs-var">serverSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">Settings
</span><span class="hs-identifier hs-var">defaultSettings</span></span><span>
</span><span id="line-224"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">HostPreference -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setHost</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. IsString a =&gt; String -&gt; a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromString</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680107608"><span class="hs-identifier hs-var">host</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setPort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680107607"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Request -&gt; SomeException -&gt; IO ()) -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setOnException</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Maybe Request
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680107590"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680107590"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#APIConnectionError"><span class="hs-identifier hs-type">APIConnectionError</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">reason :: String
</span><a href="Hydra.API.Server.html#reason"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680107590"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setBeforeMainLoop</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680107598"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621680107594"><span class="annot"><span class="annottext">wsApp :: ServerApp
</span><a href="#local-6989586621680107594"><span class="hs-identifier hs-var hs-var">wsApp</span></a></span></span><span> </span><span id="local-6989586621680107589"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621680107589"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- XXX: Moving this here improved on flakyness of tests (which would see a</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-comment">-- 'HandshakeException'). This indicates that there might be a race</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- condition between notifyingServerRunning and clients starting and</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">-- handshaking on connections still?</span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">APIServerLog
</span><a href="Hydra.API.Server.html#NewAPIConnection"><span class="hs-identifier hs-var">NewAPIConnection</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107588"><span class="annot"><span class="annottext">path :: ByteString
</span><a href="#local-6989586621680107588"><span class="hs-identifier hs-var hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestHead -&gt; ByteString
</span><span class="hs-identifier hs-var">requestPath</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; RequestHead
</span><span class="hs-identifier hs-var">pendingRequest</span></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621680107589"><span class="hs-identifier hs-var">pending</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621680107586"><span class="annot"><span class="annottext">[QueryParam]
</span><a href="#local-6989586621680107586"><span class="hs-identifier hs-var">queryParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">URI -&gt; [QueryParam]
</span><span class="hs-identifier hs-var">uriQuery</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadThrow m =&gt; ByteString -&gt; m URI
</span><span class="hs-identifier hs-var">mkURIBs</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107588"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621680107583"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107583"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; IO Connection
</span><span class="hs-identifier hs-var">acceptRequest</span></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621680107589"><span class="hs-identifier hs-var">pending</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621680107582"><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107582"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TChan a -&gt; STM (TChan a)
</span><span class="hs-identifier hs-var">dupTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107599"><span class="hs-identifier hs-var">responseChannel</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">-- api client can decide if they want to see the past history of server outputs</span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {t :: * -&gt; *}. Foldable t =&gt; t QueryParam -&gt; Bool
</span><a href="#local-6989586621680107579"><span class="hs-identifier hs-var">shouldNotServeHistory</span></a></span><span> </span><span class="annot"><span class="annottext">[QueryParam]
</span><a href="#local-6989586621680107586"><span class="hs-identifier hs-var">queryParams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-242"></span><span>      </span><span class="annot"><span class="annottext">Connection -&gt; IO ()
</span><a href="#local-6989586621680107578"><span class="hs-identifier hs-var">forwardHistory</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107583"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; IO ()
</span><a href="#local-6989586621680107577"><span class="hs-identifier hs-var">forwardGreetingOnly</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107583"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107576"><span class="annot"><span class="annottext">outConfig :: ServerOutputConfig
</span><a href="#local-6989586621680107576"><span class="hs-identifier hs-var hs-var">outConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *}.
(DisallowElem f, Foldable f) =&gt;
f QueryParam -&gt; ServerOutputConfig
</span><a href="#local-6989586621680107575"><span class="hs-identifier hs-var">mkServerOutputConfig</span></a></span><span> </span><span class="annot"><span class="annottext">[QueryParam]
</span><a href="#local-6989586621680107586"><span class="hs-identifier hs-var">queryParams</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">forall a. Connection -&gt; Int -&gt; IO () -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">withPingThread</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107583"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; IO Any
</span><a href="#local-6989586621680107574"><span class="hs-identifier hs-var">receiveInputs</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107583"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
-&gt; Connection -&gt; ServerOutputConfig -&gt; IO Any
</span><a href="#local-6989586621680107573"><span class="hs-identifier hs-var">sendOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107582"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107583"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutputConfig
</span><a href="#local-6989586621680107576"><span class="hs-identifier hs-var">outConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-comment">-- Hydra HTTP server</span><span>
</span><span id="line-252"></span><span>  </span><span id="local-6989586621680107593"><span class="annot"><span class="annottext">httpApp :: Chain tx IO -&gt; Application
</span><a href="#local-6989586621680107593"><span class="hs-identifier hs-var hs-var">httpApp</span></a></span></span><span> </span><span id="local-6989586621680107572"><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107572"><span class="hs-identifier hs-var">directChain</span></a></span></span><span> </span><span id="local-6989586621680107571"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621680107570"><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621680107570"><span class="hs-identifier hs-var">respond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; ByteString
</span><span class="hs-identifier hs-var">requestMethod</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Request -&gt; [Text]
</span><span class="hs-identifier hs-var">pathInfo</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;POST&quot;</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;commit&quot;</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>        </span><span id="local-6989586621680107569"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107569"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Request -&gt; IO ByteString
</span><span class="hs-identifier hs-var">consumeRequestBodyStrict</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">forall tx.
Chain tx IO
-&gt; Tracer IO APIServerLog
-&gt; ByteString
-&gt; ByteString
-&gt; [Text]
-&gt; (Response -&gt; IO ResponseReceived)
-&gt; IO ResponseReceived
</span><a href="Hydra.API.Server.html#handleDraftCommitUtxo"><span class="hs-identifier hs-var">handleDraftCommitUtxo</span></a></span><span> </span><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107572"><span class="hs-identifier hs-var">directChain</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107569"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; ByteString
</span><span class="hs-identifier hs-var">requestMethod</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; [Text]
</span><span class="hs-identifier hs-var">pathInfo</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621680107570"><span class="hs-identifier hs-var">respond</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="annottext">(ByteString, [Text])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-259"></span><span>          </span><span class="annot"><a href="Hydra.API.Server.html#APIRestInputReceived"><span class="hs-identifier hs-type">APIRestInputReceived</span></a></span><span>
</span><span id="line-260"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">method :: Text
</span><a href="Hydra.API.Server.html#method"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. ConvertUtf8 a b =&gt; b -&gt; a
</span><span class="hs-identifier hs-var">decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; ByteString
</span><span class="hs-identifier hs-var">requestMethod</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-261"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">paths :: [Text]
</span><a href="Hydra.API.Server.html#paths"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; [Text]
</span><span class="hs-identifier hs-var">pathInfo</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621680107571"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-262"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">requestInputBody :: Maybe Value
</span><a href="Hydra.API.Server.html#requestInputBody"><span class="hs-identifier hs-var">requestInputBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621680107570"><span class="hs-identifier hs-var">respond</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Status -&gt; ResponseHeaders -&gt; ByteString -&gt; Response
</span><span class="hs-identifier hs-var">responseLBS</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">status400</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Resource not found&quot;</span></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-comment">-- NOTE: We will add a 'Greetings' message on each API server start. This is</span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-comment">-- important to make sure the latest configured 'party' is reaching the</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-comment">-- client.</span><span>
</span><span id="line-269"></span><span>  </span><span id="local-6989586621680107577"><span class="annot"><span class="annottext">forwardGreetingOnly :: Connection -&gt; IO ()
</span><a href="#local-6989586621680107577"><span class="hs-identifier hs-var hs-var">forwardGreetingOnly</span></a></span></span><span> </span><span id="local-6989586621680107566"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107566"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>    </span><span id="local-6989586621680107565"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680107565"><span class="hs-identifier hs-var">seq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tx. TVar [TimedServerOutput tx] -&gt; STM Natural
</span><a href="Hydra.API.Server.html#nextSequenceNumber"><span class="hs-identifier hs-var">nextSequenceNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107604"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621680107564"><span class="annot"><span class="annottext">HeadStatus
</span><a href="#local-6989586621680107564"><span class="hs-identifier hs-var">headStatus</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM HeadStatus
</span><a href="#local-6989586621680107563"><span class="hs-identifier hs-var">getLatestHeadStatus</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621680107562"><span class="annot"><span class="annottext">Maybe (UTxOType tx)
</span><a href="#local-6989586621680107562"><span class="hs-identifier hs-var">snapshotUtxo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107561"><span class="hs-identifier hs-var">getLatestSnapshotUtxo</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621680107560"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680107560"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadTime m =&gt; m UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">sendTextData</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107566"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span>
</span><span id="line-278"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">UTCTime
time :: UTCTime
time :: UTCTime
</span><a href="#local-6989586621680107560"><span class="hs-identifier hs-var hs-var">time</span></a></span><span>
</span><span id="line-279"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
seq :: Natural
seq :: Natural
</span><a href="#local-6989586621680107565"><span class="hs-identifier hs-var hs-var">seq</span></a></span><span>
</span><span id="line-280"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">output :: ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#output"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>              </span><span class="annot"><a href="Hydra.API.ServerOutput.html#Greetings"><span class="hs-identifier hs-type">Greetings</span></a></span><span>
</span><span id="line-282"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">me :: Party
</span><a href="Hydra.API.ServerOutput.html#me"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680107606"><span class="hs-identifier hs-var">party</span></a></span><span>
</span><span id="line-283"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeadStatus
headStatus :: HeadStatus
headStatus :: HeadStatus
</span><a href="#local-6989586621680107564"><span class="hs-identifier hs-var hs-var">headStatus</span></a></span><span>
</span><span id="line-284"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (UTxOType tx)
snapshotUtxo :: Maybe (UTxOType tx)
snapshotUtxo :: Maybe (UTxOType tx)
</span><a href="#local-6989586621680107562"><span class="hs-identifier hs-var hs-var">snapshotUtxo</span></a></span><span>
</span><span id="line-285"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hydraNodeVersion :: String
</span><a href="Hydra.API.ServerOutput.html#hydraNodeVersion"><span class="hs-identifier hs-var">hydraNodeVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; String
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">showVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Hydra.Options.html#hydraNodeVersion"><span class="hs-identifier hs-var">Options.hydraNodeVersion</span></a></span><span>
</span><span id="line-286"></span><span>                </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-287"></span><span>                </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier hs-type">ServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-288"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier hs-type">Projection</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">getLatest :: forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; stm model
</span><a href="Hydra.API.Projection.html#getLatest"><span class="hs-identifier hs-var">getLatest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680107563"><span class="annot"><span class="annottext">STM HeadStatus
</span><a href="#local-6989586621680107563"><span class="hs-identifier hs-var">getLatestHeadStatus</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680107601"><span class="hs-identifier hs-var">headStatusP</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier hs-type">Projection</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">getLatest :: forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; stm model
</span><a href="Hydra.API.Projection.html#getLatest"><span class="hs-identifier hs-var">getLatest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680107561"><span class="annot"><span class="annottext">STM (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107561"><span class="hs-identifier hs-var">getLatestSnapshotUtxo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680107600"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621680107575"><span class="annot"><span class="annottext">mkServerOutputConfig :: f QueryParam -&gt; ServerOutputConfig
</span><a href="#local-6989586621680107575"><span class="hs-identifier hs-var hs-var">mkServerOutputConfig</span></a></span></span><span> </span><span id="local-6989586621680107549"><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107549"><span class="hs-identifier hs-var">qp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutputConfig"><span class="hs-identifier hs-type">ServerOutputConfig</span></a></span><span>
</span><span id="line-295"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">txOutputFormat :: OutputFormat
</span><a href="Hydra.API.ServerOutput.html#txOutputFormat"><span class="hs-identifier hs-var">txOutputFormat</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *}.
(DisallowElem f, Foldable f) =&gt;
f QueryParam -&gt; OutputFormat
</span><a href="#local-6989586621680107546"><span class="hs-identifier hs-var">decideOnTxDisplay</span></a></span><span> </span><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107549"><span class="hs-identifier hs-var">qp</span></a></span><span>
</span><span id="line-296"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">utxoInSnapshot :: WithUTxO
</span><a href="Hydra.API.ServerOutput.html#utxoInSnapshot"><span class="hs-identifier hs-var">utxoInSnapshot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *}.
(DisallowElem f, Foldable f) =&gt;
f QueryParam -&gt; WithUTxO
</span><a href="#local-6989586621680107544"><span class="hs-identifier hs-var">decideOnUTxODisplay</span></a></span><span> </span><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107549"><span class="hs-identifier hs-var">qp</span></a></span><span>
</span><span id="line-297"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>  </span><span id="local-6989586621680107546"><span class="annot"><span class="annottext">decideOnTxDisplay :: f QueryParam -&gt; OutputFormat
</span><a href="#local-6989586621680107546"><span class="hs-identifier hs-var hs-var">decideOnTxDisplay</span></a></span></span><span> </span><span id="local-6989586621680107537"><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107537"><span class="hs-identifier hs-var">qp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107536"><span class="annot"><span class="annottext">k :: RText l
</span><a href="#local-6989586621680107536"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[queryKey|tx-output|]</span></span><span>
</span><span id="line-301"></span><span>        </span><span id="local-6989586621680107534"><span class="annot"><span class="annottext">v :: RText l
</span><a href="#local-6989586621680107534"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[queryValue|cbor|]</span></span><span>
</span><span id="line-302"></span><span>        </span><span id="local-6989586621680107533"><span class="annot"><span class="annottext">queryP :: QueryParam
</span><a href="#local-6989586621680107533"><span class="hs-identifier hs-var hs-var">queryP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RText 'QueryKey -&gt; RText 'QueryValue -&gt; QueryParam
</span><span class="hs-identifier hs-var">QueryParam</span></span><span> </span><span class="annot"><span class="annottext">forall {l :: RTextLabel}. RText l
</span><a href="#local-6989586621680107536"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">forall {l :: RTextLabel}. RText l
</span><a href="#local-6989586621680107534"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-303"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">QueryParam
</span><a href="#local-6989586621680107533"><span class="hs-identifier hs-var">queryP</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a.
(Foldable f, DisallowElem f, Eq a) =&gt;
a -&gt; f a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107537"><span class="hs-identifier hs-var">qp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">OutputFormat
</span><a href="Hydra.API.ServerOutput.html#OutputCBOR"><span class="hs-identifier hs-var">OutputCBOR</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">OutputFormat
</span><a href="Hydra.API.ServerOutput.html#OutputJSON"><span class="hs-identifier hs-var">OutputJSON</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>  </span><span id="local-6989586621680107544"><span class="annot"><span class="annottext">decideOnUTxODisplay :: f QueryParam -&gt; WithUTxO
</span><a href="#local-6989586621680107544"><span class="hs-identifier hs-var hs-var">decideOnUTxODisplay</span></a></span></span><span> </span><span id="local-6989586621680107523"><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107523"><span class="hs-identifier hs-var">qp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107522"><span class="annot"><span class="annottext">k :: RText l
</span><a href="#local-6989586621680107522"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[queryKey|snapshot-utxo|]</span></span><span>
</span><span id="line-307"></span><span>        </span><span id="local-6989586621680107521"><span class="annot"><span class="annottext">v :: RText l
</span><a href="#local-6989586621680107521"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[queryValue|no|]</span></span><span>
</span><span id="line-308"></span><span>        </span><span id="local-6989586621680107520"><span class="annot"><span class="annottext">queryP :: QueryParam
</span><a href="#local-6989586621680107520"><span class="hs-identifier hs-var hs-var">queryP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RText 'QueryKey -&gt; RText 'QueryValue -&gt; QueryParam
</span><span class="hs-identifier hs-var">QueryParam</span></span><span> </span><span class="annot"><span class="annottext">forall {l :: RTextLabel}. RText l
</span><a href="#local-6989586621680107522"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">forall {l :: RTextLabel}. RText l
</span><a href="#local-6989586621680107521"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-309"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">QueryParam
</span><a href="#local-6989586621680107520"><span class="hs-identifier hs-var">queryP</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a.
(Foldable f, DisallowElem f, Eq a) =&gt;
a -&gt; f a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">f QueryParam
</span><a href="#local-6989586621680107523"><span class="hs-identifier hs-var">qp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">WithUTxO
</span><a href="Hydra.API.ServerOutput.html#WithoutUTxO"><span class="hs-identifier hs-var">WithoutUTxO</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">WithUTxO
</span><a href="Hydra.API.ServerOutput.html#WithUTxO"><span class="hs-identifier hs-var">WithUTxO</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>  </span><span id="local-6989586621680107579"><span class="annot"><span class="annottext">shouldNotServeHistory :: t QueryParam -&gt; Bool
</span><a href="#local-6989586621680107579"><span class="hs-identifier hs-var hs-var">shouldNotServeHistory</span></a></span></span><span> </span><span id="local-6989586621680107512"><span class="annot"><span class="annottext">t QueryParam
</span><a href="#local-6989586621680107512"><span class="hs-identifier hs-var">qp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="annot"><span class="annottext">t QueryParam
</span><a href="#local-6989586621680107512"><span class="hs-identifier hs-var">qp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-313"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">QueryParam</span></span><span> </span><span id="local-6989586621680107509"><span class="annot"><span class="annottext">RText 'QueryKey
</span><a href="#local-6989586621680107509"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621680107508"><span class="annot"><span class="annottext">RText 'QueryValue
</span><a href="#local-6989586621680107508"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RText 'QueryKey
</span><a href="#local-6989586621680107509"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="">[queryKey|history|]</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RText 'QueryValue
</span><a href="#local-6989586621680107508"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="">[queryValue|no|]</span></span><span>
</span><span id="line-315"></span><span>      </span><span id="local-6989586621680107507"><span class="annot"><span class="annottext">QueryParam
</span><a href="#local-6989586621680107507"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>  </span><span id="local-6989586621680107596"><span class="annot"><span class="annottext">onIOException :: IOException -&gt; IO ()
</span><a href="#local-6989586621680107596"><span class="hs-identifier hs-var hs-var">onIOException</span></a></span></span><span> </span><span id="local-6989586621680107506"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680107506"><span class="hs-identifier hs-var">ioException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-319"></span><span>      </span><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-type">RunServerException</span></a></span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">IOException
ioException :: IOException
ioException :: IOException
</span><a href="Hydra.API.Server.html#ioException"><span class="hs-identifier hs-var hs-var">ioException</span></a></span><span>
</span><span id="line-321"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IP
host :: IP
host :: IP
</span><a href="Hydra.API.Server.html#host"><span class="hs-identifier hs-var hs-var">host</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PortNumber
port :: PortNumber
port :: PortNumber
</span><a href="Hydra.API.Server.html#port"><span class="hs-identifier hs-var hs-var">port</span></a></span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621680107573"><span class="annot"><span class="annottext">sendOutputs :: TChan (TimedServerOutput tx)
-&gt; Connection -&gt; ServerOutputConfig -&gt; IO Any
</span><a href="#local-6989586621680107573"><span class="hs-identifier hs-var hs-var">sendOutputs</span></a></span></span><span> </span><span id="local-6989586621680107500"><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107500"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span id="local-6989586621680107499"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107499"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621680107498"><span class="annot"><span class="annottext">ServerOutputConfig
</span><a href="#local-6989586621680107498"><span class="hs-identifier hs-var">outConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621680107496"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107496"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. TChan a -&gt; STM a
</span><span class="hs-identifier hs-var">readTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680107500"><span class="hs-identifier hs-var">chan</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107495"><span class="annot"><span class="annottext">sentResponse :: ByteString
</span><a href="#local-6989586621680107495"><span class="hs-identifier hs-var hs-var">sentResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><span class="annottext">forall tx.
IsChainState tx =&gt;
ServerOutputConfig -&gt; TimedServerOutput tx -&gt; ByteString
</span><a href="Hydra.API.ServerOutput.html#prepareServerOutput"><span class="hs-identifier hs-var">prepareServerOutput</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutputConfig
</span><a href="#local-6989586621680107498"><span class="hs-identifier hs-var">outConfig</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107496"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">sendTextData</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107499"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107495"><span class="hs-identifier hs-var">sentResponse</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIOutputSent"><span class="hs-identifier hs-var">APIOutputSent</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107496"><span class="hs-identifier hs-var">response</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>  </span><span id="local-6989586621680107574"><span class="annot"><span class="annottext">receiveInputs :: Connection -&gt; IO Any
</span><a href="#local-6989586621680107574"><span class="hs-identifier hs-var hs-var">receiveInputs</span></a></span></span><span> </span><span id="local-6989586621680107493"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107493"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621680107492"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107492"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. WebSocketsData a =&gt; Connection -&gt; IO a
</span><span class="hs-identifier hs-var">receiveData</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107493"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. FromJSON a =&gt; ByteString -&gt; Either String a
</span><span class="hs-identifier hs-var">Aeson.eitherDecode</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107492"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-336"></span><span>      </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680107490"><span class="annot"><span class="annottext">ClientInput tx
</span><a href="#local-6989586621680107490"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIInputReceived"><span class="hs-identifier hs-var">APIInputReceived</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">ClientInput tx
</span><a href="#local-6989586621680107490"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="annottext">ClientInput tx -&gt; IO ()
</span><a href="#local-6989586621680107602"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">ClientInput tx
</span><a href="#local-6989586621680107490"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-339"></span><span>      </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680107489"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680107489"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-comment">-- XXX(AB): toStrict might be problematic as it implies consuming the full</span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-comment">-- message to memory</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107488"><span class="annot"><span class="annottext">clientInput :: Text
</span><a href="#local-6989586621680107488"><span class="hs-identifier hs-var hs-var">clientInput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnDecodeError -&gt; ByteString -&gt; Text
</span><span class="hs-identifier hs-var">decodeUtf8With</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError
</span><span class="hs-identifier hs-var">lenientDecode</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall l s. LazyStrict l s =&gt; l -&gt; s
</span><span class="hs-identifier hs-var">toStrict</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107492"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span id="local-6989586621680107484"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680107484"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadTime m =&gt; m UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-344"></span><span>        </span><span id="local-6989586621680107483"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680107483"><span class="hs-identifier hs-var">seq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tx. TVar [TimedServerOutput tx] -&gt; STM Natural
</span><a href="Hydra.API.Server.html#nextSequenceNumber"><span class="hs-identifier hs-var">nextSequenceNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107604"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107482"><span class="annot"><span class="annottext">timedOutput :: TimedServerOutput tx
</span><a href="#local-6989586621680107482"><span class="hs-identifier hs-var hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">output :: ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#output"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall tx. String -&gt; Text -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#InvalidInput"><span class="hs-identifier hs-var">InvalidInput</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680108837"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680107489"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680107488"><span class="hs-identifier hs-var">clientInput</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTCTime
time :: UTCTime
time :: UTCTime
</span><a href="#local-6989586621680107484"><span class="hs-identifier hs-var hs-var">time</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
seq :: Natural
seq :: Natural
</span><a href="#local-6989586621680107483"><span class="hs-identifier hs-var hs-var">seq</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="annottext">forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">sendTextData</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107493"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680107482"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107605"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text -&gt; APIServerLog
</span><a href="Hydra.API.Server.html#APIInvalidInput"><span class="hs-identifier hs-var">APIInvalidInput</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680107489"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680107488"><span class="hs-identifier hs-var">clientInput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>  </span><span id="local-6989586621680107578"><span class="annot"><span class="annottext">forwardHistory :: Connection -&gt; IO ()
</span><a href="#local-6989586621680107578"><span class="hs-identifier hs-var hs-var">forwardHistory</span></a></span></span><span> </span><span id="local-6989586621680107481"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107481"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>    </span><span id="local-6989586621680107480"><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680107480"><span class="hs-identifier hs-var">hist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680107604"><span class="hs-identifier hs-var">history</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680107477"><span class="annot"><span class="annottext">encodeAndReverse :: [ByteString] -&gt; a -&gt; [ByteString]
</span><a href="#local-6989586621680107477"><span class="hs-identifier hs-var hs-var">encodeAndReverse</span></a></span></span><span> </span><span id="local-6989586621680107476"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621680107476"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621680107475"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680107475"><span class="hs-identifier hs-var">serverOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680107475"><span class="hs-identifier hs-var">serverOutput</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621680107476"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">forall a. WebSocketsData a =&gt; Connection -&gt; [a] -&gt; IO ()
</span><span class="hs-identifier hs-var">sendTextDatas</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680107481"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. ToJSON a =&gt; [ByteString] -&gt; a -&gt; [ByteString]
</span><a href="#local-6989586621680107477"><span class="hs-identifier hs-var">encodeAndReverse</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680107480"><span class="hs-identifier hs-var">hist</span></a></span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="hs-keyword">data</span><span> </span><span id="RunServerException"><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-var">RunServerException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RunServerException"><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-var">RunServerException</span></a></span></span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ioException"><span class="annot"><span class="annottext">RunServerException -&gt; IOException
</span><a href="Hydra.API.Server.html#ioException"><span class="hs-identifier hs-var hs-var">ioException</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">IOException</span></a></span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="host"><span class="annot"><span class="annottext">RunServerException -&gt; IP
</span><a href="Hydra.API.Server.html#host"><span class="hs-identifier hs-var hs-var">host</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="port"><span class="annot"><span class="annottext">RunServerException -&gt; PortNumber
</span><a href="Hydra.API.Server.html#port"><span class="hs-identifier hs-var hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680107463"><span id="local-6989586621680107465"><span id="local-6989586621680107472"><span class="annot"><span class="annottext">Int -&gt; RunServerException -&gt; ShowS
[RunServerException] -&gt; ShowS
RunServerException -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RunServerException] -&gt; ShowS
$cshowList :: [RunServerException] -&gt; ShowS
show :: RunServerException -&gt; String
$cshow :: RunServerException -&gt; String
showsPrec :: Int -&gt; RunServerException -&gt; ShowS
$cshowsPrec :: Int -&gt; RunServerException -&gt; ShowS
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680107453"><span id="local-6989586621680107455"><span id="local-6989586621680107457"><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-type">RunServerException</span></a></span></span></span></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="hs-comment">-- Handle user requests to obtain a draft commit tx</span><span>
</span><span id="line-364"></span><span id="local-6989586621680108764"><span class="annot"><a href="Hydra.API.Server.html#handleDraftCommitUtxo"><span class="hs-identifier hs-type">handleDraftCommitUtxo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-365"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680108764"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#APIServerLog"><span class="hs-identifier hs-type">APIServerLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-367"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">LBS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Method</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseReceived</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-371"></span><span>  </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseReceived</span></span></span><span>
</span><span id="line-372"></span><span id="handleDraftCommitUtxo"><span class="annot"><span class="annottext">handleDraftCommitUtxo :: forall tx.
Chain tx IO
-&gt; Tracer IO APIServerLog
-&gt; ByteString
-&gt; ByteString
-&gt; [Text]
-&gt; (Response -&gt; IO ResponseReceived)
-&gt; IO ResponseReceived
</span><a href="Hydra.API.Server.html#handleDraftCommitUtxo"><span class="hs-identifier hs-var hs-var">handleDraftCommitUtxo</span></a></span></span><span> </span><span id="local-6989586621680107431"><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107431"><span class="hs-identifier hs-var">directChain</span></a></span></span><span> </span><span id="local-6989586621680107430"><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107430"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680107429"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107429"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621680107428"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107428"><span class="hs-identifier hs-var">reqMethod</span></a></span></span><span> </span><span id="local-6989586621680107427"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680107427"><span class="hs-identifier hs-var">reqPaths</span></a></span></span><span> </span><span id="local-6989586621680107426"><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621680107426"><span class="hs-identifier hs-var">respond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. FromJSON a =&gt; ByteString -&gt; Either String a
</span><span class="hs-identifier hs-var">Aeson.eitherDecode'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107429"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="annot"><a href="Hydra.API.RestServer.html#DraftCommitTxRequest"><span class="hs-identifier hs-type">DraftCommitTxRequest</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-374"></span><span>    </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680107424"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680107424"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>      </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621680107426"><span class="hs-identifier hs-var">respond</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Status -&gt; ResponseHeaders -&gt; ByteString -&gt; Response
</span><span class="hs-identifier hs-var">responseLBS</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">status400</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
</span><span class="hs-identifier hs-var">Aeson.String</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680107424"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680107422"><span class="annot"><span class="annottext">requestInput :: DraftCommitTxRequest
</span><a href="#local-6989586621680107422"><span class="hs-identifier hs-var">requestInput</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hydra.API.RestServer.html#DraftCommitTxRequest"><span class="hs-identifier hs-type">DraftCommitTxRequest</span></a></span><span class="hs-special">{</span><span id="local-6989586621680107420"><span class="annot"><span class="annottext">UTxO' TxOutWithWitness
utxoToCommit :: DraftCommitTxRequest -&gt; UTxO' TxOutWithWitness
utxoToCommit :: UTxO' TxOutWithWitness
</span><a href="Hydra.API.RestServer.html#utxoToCommit"><span class="hs-identifier hs-var hs-var">utxoToCommit</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680107430"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><a href="Hydra.API.Server.html#APIRestInputReceived"><span class="hs-identifier hs-type">APIRestInputReceived</span></a></span><span>
</span><span id="line-379"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">method :: Text
</span><a href="Hydra.API.Server.html#method"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. ConvertUtf8 a b =&gt; b -&gt; a
</span><span class="hs-identifier hs-var">decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680107428"><span class="hs-identifier hs-var">reqMethod</span></a></span><span>
</span><span id="line-380"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">paths :: [Text]
</span><a href="Hydra.API.Server.html#paths"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680107427"><span class="hs-identifier hs-var">reqPaths</span></a></span><span>
</span><span id="line-381"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">requestInputBody :: Maybe Value
</span><a href="Hydra.API.Server.html#requestInputBody"><span class="hs-identifier hs-var">requestInputBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">DraftCommitTxRequest
</span><a href="#local-6989586621680107422"><span class="hs-identifier hs-var">requestInput</span></a></span><span>
</span><span id="line-382"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-383"></span><span>      </span><span id="local-6989586621680107418"><span class="annot"><span class="annottext">Either (PostTxError Tx) Tx
</span><a href="#local-6989586621680107418"><span class="hs-identifier hs-var">eCommitTx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MonadThrow IO, MonadIO IO) =&gt;
UTxO' (TxOut CtxUTxO, Witness WitCtxTxIn)
-&gt; IO (Either (PostTxError Tx) Tx)
</span><a href="#local-6989586621680107417"><span class="hs-identifier hs-var">draftCommitTx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutWithWitness -&gt; (TxOut CtxUTxO, Witness WitCtxTxIn)
</span><a href="Hydra.API.RestServer.html#fromTxOutWithWitness"><span class="hs-identifier hs-var">fromTxOutWithWitness</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO' TxOutWithWitness
</span><a href="#local-6989586621680107420"><span class="hs-identifier hs-var">utxoToCommit</span></a></span><span>
</span><span id="line-384"></span><span>      </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621680107426"><span class="hs-identifier hs-var">respond</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (PostTxError Tx) Tx
</span><a href="#local-6989586621680107418"><span class="hs-identifier hs-var">eCommitTx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-386"></span><span>          </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680107416"><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107416"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-387"></span><span>            </span><span class="hs-comment">-- Distinguish between errors users can actually benefit from and</span><span>
</span><span id="line-388"></span><span>            </span><span class="hs-comment">-- other errors that are turned into 500 responses.</span><span>
</span><span id="line-389"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107416"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-390"></span><span>              </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="Hydra.Chain.html#CannotCommitReferenceScript"><span class="hs-identifier hs-var">CannotCommitReferenceScript</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PostTxError Tx -&gt; Response
</span><a href="#local-6989586621680107415"><span class="hs-identifier hs-var">return400</span></a></span><span> </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107416"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-391"></span><span>              </span><span class="annot"><a href="Hydra.Chain.html#CommittedTooMuchADAForMainnet"><span class="hs-identifier hs-type">CommittedTooMuchADAForMainnet</span></a></span><span> </span><span class="annot"><span class="annottext">Lovelace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Lovelace
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PostTxError Tx -&gt; Response
</span><a href="#local-6989586621680107415"><span class="hs-identifier hs-var">return400</span></a></span><span> </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107416"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-392"></span><span>              </span><span class="annot"><a href="Hydra.Chain.html#UnsupportedLegacyOutput"><span class="hs-identifier hs-type">UnsupportedLegacyOutput</span></a></span><span> </span><span class="annot"><span class="annottext">Address ByronAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PostTxError Tx -&gt; Response
</span><a href="#local-6989586621680107415"><span class="hs-identifier hs-var">return400</span></a></span><span> </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107416"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-393"></span><span>              </span><span id="local-6989586621680107414"><span class="annot"><span class="annottext">walletUtxoErr :: PostTxError Tx
</span><a href="#local-6989586621680107414"><span class="hs-identifier hs-var">walletUtxoErr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="Hydra.Chain.html#SpendingNodeUtxoForbidden"><span class="hs-identifier hs-var">SpendingNodeUtxoForbidden</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PostTxError Tx -&gt; Response
</span><a href="#local-6989586621680107415"><span class="hs-identifier hs-var">return400</span></a></span><span> </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107414"><span class="hs-identifier hs-var">walletUtxoErr</span></a></span><span>
</span><span id="line-394"></span><span>              </span><span class="annot"><span class="annottext">PostTxError Tx
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Status -&gt; ResponseHeaders -&gt; ByteString -&gt; Response
</span><span class="hs-identifier hs-var">responseLBS</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">status500</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">PostTxError Tx
</span><a href="#local-6989586621680107416"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>          </span><span class="annot"><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680107413"><span class="annot"><span class="annottext">Tx
</span><a href="#local-6989586621680107413"><span class="hs-identifier hs-var">commitTx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="annottext">Status -&gt; ResponseHeaders -&gt; ByteString -&gt; Response
</span><span class="hs-identifier hs-var">responseLBS</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">status200</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx -&gt; DraftCommitTxResponse
</span><a href="Hydra.API.RestServer.html#DraftCommitTxResponse"><span class="hs-identifier hs-var">DraftCommitTxResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Tx
</span><a href="#local-6989586621680107413"><span class="hs-identifier hs-var">commitTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-398"></span><span>  </span><span id="local-6989586621680107415"><span class="annot"><span class="annottext">return400 :: PostTxError Tx -&gt; Response
</span><a href="#local-6989586621680107415"><span class="hs-identifier hs-var hs-var">return400</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Status -&gt; ResponseHeaders -&gt; ByteString -&gt; Response
</span><span class="hs-identifier hs-var">responseLBS</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">status400</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/bsq0l6l46al1xy42xf3gvwwyys8vdbz1-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier hs-type">Chain</span></a></span><span class="hs-special">{</span><span id="local-6989586621680107417"><span class="annot"><span class="annottext">(MonadThrow IO, MonadIO IO) =&gt;
UTxO' (TxOut CtxUTxO, Witness WitCtxTxIn)
-&gt; IO (Either (PostTxError Tx) Tx)
$sel:draftCommitTx:Chain :: forall tx (m :: * -&gt; *).
Chain tx m
-&gt; (MonadThrow m, MonadIO m) =&gt;
   UTxO' (TxOut CtxUTxO, Witness WitCtxTxIn)
   -&gt; m (Either (PostTxError Tx) Tx)
draftCommitTx :: (MonadThrow IO, MonadIO IO) =&gt;
UTxO' (TxOut CtxUTxO, Witness WitCtxTxIn)
-&gt; IO (Either (PostTxError Tx) Tx)
</span><a href="Hydra.Chain.html#%24sel%3AdraftCommitTx%3AChain"><span class="hs-identifier hs-var hs-var">draftCommitTx</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680107431"><span class="hs-identifier hs-var">directChain</span></a></span><span>
</span><span id="line-401"></span></pre></body></html>